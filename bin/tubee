#!/usr/bin/env php
<?php

use Framework\Config\Environment;
use Framework\Mysql\ConnectionPool;
use Framework\Mysql\Mysql;
use React\MySQL\Exception;
use React\MySQL\QueryResult;

if (PHP_SAPI !== 'cli') {
    echo 'bin/tubee must be run as a CLI application';
    exit(1);
}

try {
    require __DIR__ . '/../src/app/bootstrap.php';
} catch (\Exception $e) {
    echo 'Autoload error: ' . $e->getMessage();
    exit(1);
}

try {
    $environment = new Environment();
    $mysql = new Mysql($environment);
    $connectionPool = new ConnectionPool($mysql);
    $connection = $connectionPool->getConnection();
} catch (\Exception $e) {
    echo 'Load Application error: ' . $e;
    exit(1);
}

$youtube = $argv[1];

try {
    $staticPath = $environment->getStaticPath();

    echo $youtube . "\n";
    insertYoutube($connection, $youtube);

    $command = "cd ${staticPath}/mp3 && youtube-dl --extract-audio --audio-format mp3 -o '%(title)s.%(ext)s' ${youtube} | grep Destination ";
    $output = shell_exec($command);
    echo $output . "\n";

    $lines = preg_split("/\r\n|\n|\r/", $output);
    $name = '';
    foreach ($lines as $line) {
        $re = '/^\[ffmpeg] Destination:/';
        preg_match_all($re, $line, $matches, PREG_SET_ORDER, 0);
        if (count($matches)) {
            $name = substr($line, strlen($matches[0][0]));
            $name = trim($name);
        }
    }

    updateYoutube($connection, $youtube, $name, 1);
} catch (\Exception $e) {
    updateYoutube($connection, $youtube, null, 0);
    echo 'Downloading error:' . $e;
    exit(1);
}

/**
 * @param $connection
 * @param $youtube
 * @return void
 */
function insertYoutube($connection, $youtube)
{
    $value = $youtube;
    $query = 'INSERT INTO youtube (hash, name, link, status)
                VALUES (?,?,?, 1)';
    $connection->query($query, [$value, $value, $value])->then(
        function (QueryResult $command) use ($query) {
            echo 'Successfully ' . $query . PHP_EOL;
        },
        function (Exception $error) use ($query) {
            echo 'Error ' . $query . PHP_EOL;
        }
    );
}

/**
 * @param $connection
 * @param $youtubeURL
 * @param $name
 * @param $status
 * @return void
 */
function updateYoutube($connection, $youtubeURL, $name, $status)
{
    $query = 'UPDATE youtube SET status=?, name=? WHERE link=?';
    $connection->query($query, [$status, $name, $youtubeURL])->then(
        function (QueryResult $command) use ($query) {
            echo 'Successfully ' . $query . PHP_EOL;
        },
        function (Exception $error) use ($query) {
            echo 'Error ' . $query . PHP_EOL;
        }
    );
}
